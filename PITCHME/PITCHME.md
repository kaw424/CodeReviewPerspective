<!-- ---?color=#222222 -->

### コードを観る視点

#### 「将来を見据えた息の長いコードを残す」ための<br>　判断基準<br><br>

<div style="text-align: right;">
白井 誠  

[@fa[github]@shirai](https://github.com/shirai)  
[@fa[twitter]@shirai_makoto](https://twitter.com/shirai_makoto)
</div>

---

#### ＜今回のテーマ＞

## <div style="text-align: center;"><font color="yellow">ソースコードレビュー</font></div>

@ul[squares]

- 私が何を見てレビューしているのか？
- 対応方針をどう決めているのか？

@ulend

---

唐突ですが

---

私が

### これまで触ってきた言語一覧

を紹介します

---

| 現場 | 言語
|:--|:--
|iOSアプリ開発|Swift, Objective-C
|Androidアプリ開発|Java
|Webサイト開発|Java, JavaScript, PHP
|Webバックエンド開発|Perl, Bash
|Windowsパッケージソフトウェア開発|Visual Basic .NET
|Windowsクライアントアプリ開発|C++, C#
|組み込み|C

|（趣味）
|:--|:--
|Ruby, Python, Kotlin, ActionScript, AppleScript

---

そこそこバリエーションありますね。
では、

## どの現場で活かせる話が始まる？

---

| 現場 | 言語
|:--|:--
|iOSアプリ開発|Swift, Objective-C
|Androidアプリ開発|Java
|Webサイト開発|Java, JavaScript, PHP
|Webバックエンド開発|Perl, Bash
|Windowsパッケージソフトウェア開発|Visual Basic .NET
|Windowsクライアントアプリ開発|C++, C#
|組み込み|C

|（趣味）
|:--|:--
|Ruby, Python, Kotlin, ActionScript, AppleScript

---

| 現場 | 言語
|:--|:--
|<font color="red">iOSアプリ開発|<font color="red">Swift, Objective-C
|<font color="red">Androidアプリ開発|<font color="red">Java
|<font color="red">Webサイト開発|<font color="red">Java, JavaScript, PHP
|<font color="red">Webバックエンド開発|<font color="red">Perl, Bash
|<font color="red">Windowsパッケージソフトウェア開発|<font color="red">Visual Basic .NET
|<font color="red">Windowsクライアントアプリ開発|<font color="red">C++, C#
|<font color="red">組み込み|<font color="red">C

|（趣味）
|:--|:--
|Ruby, Python, Kotlin, ActionScript, AppleScript

---

# <div style="text-align: center;"><font color="red">！！！</font></div>

---

言語・フレームワーク問わず、  

### <font color="yellow">どんな現場でも使える話！</font>

- 「Ruby, Pythonでは使えない」って意味じゃないです  
「趣味で個人開発する時」にはあまり向かないだけ |

---

## 今回の話のターゲット

@ul[squares]

- レビュア経験の少ない **次期アーキテクト候補**
- レビュー指摘対応が長引く **若手エンジニア**

@ulend

---

レビュー時はもちろん  
**コーディング時にも参考にしていただきたいです！**

---

### キーワード

# プリンシプル

> プログラミングの指針となる「前提」「原則」「思想」「習慣」「視点」「手法」「法則」などのことです。  
（「プリンシプル オブ プログラミング」より）

今回は「視点」にフォーカスを当てたお話

---

### 登場するプリンシプル

@ul[squares]

- コードの臭い
- 技術的負債

@ulend

---

### 「コードの臭い」「技術的負債」

数あるプリンシプルの中でも、耳にする機会の多い単語２つかと思います。

今回は "私がレビューする時の指針" として、  
**「プリンシプルをどのように活用しているか」**  
を紹介していきます。

---

（紹介に入る前に）

## <font color="yellow">留意点</font>

- あくまでもプリンシプルが使える場面の「一例」
- 「これだけ知っていれば「誰でもレビュアになれる」  
という話ではない  
  - どうしても言語・フレームワーク・PJに依存する部分はある（後述）
- いきなり主義主張を語り出すことがあります |
  - が、実はそれを語るための前座としてプリンシプル紹介だったりもするので温かく見守ってほしいです） |

---

# <div style="text-align: center;">本題</div>

---

## プリンシプルを用いた<br>　レビューの流れ

1. 「コードの臭い」を感じ取り指摘を入れる
---

## プリンシプルを用いた<br>　レビューの流れ

1. 「コードの臭い」を感じ取り指摘を入れる
1. （「原則」に基づき "あるべき姿" を導き出す）
---

## プリンシプルを用いた<br>　レビューの流れ

1. 「コードの臭い」を感じ取り指摘を入れる
1. （「原則」に基づき "あるべき姿" を導き出す）
1. 「技術的負債」の考え方を用いて<br>　対応方針を検討する

---

### 1. 「コードの臭い」を<font color="yellow">感じ取り</font><br>　　指摘を入れる

---

## コードの臭いとは何か？

> 「コードの臭い」とは、コードの中で、理解しにくい、修正しにくい、拡張しにくい、と感じられる部分のことです。

> このコードの問題点の嫌疑を、不吉な兆候として、怪しいサインとして、「臭い」と呼びます。

---

### 「臭い」＝「凶兆」

＜レビュー時＞  
今書いてある処理が、

- 「正しく動くか？」  
　　という観点ではなく、
- <font color="yellow">「今後メンテナンスできるものか？」</font>  
　　という観点でレビューをする。

---

#### 臭いの傾向を知る

|悪臭|チェック内容|
|:--:|:--|
|よく見る|同じ処理を複数箇所に記載していないか？
|大きすぎる|１つの処理が担う役割が大きすぎないか？
|長すぎる|縦に長すぎないか？（処理過多）<br>横に長すぎないか？（改行不足）
|名前が合わない|処理名と内容が一致しているか？<br>似た処理の命名ルールが揃っているか？

---

#### どんなリスクが潜んでいるか知る

|チェック内容|リスク
|:--|:--|
|同じ処理を複数箇所に記載していないか？|修正コスト増
|１つの処理が担う役割が大きすぎないか？|予想外の箇所への影響
|縦に長すぎないか？（処理過多）|予想外の箇所への影響
|横に長すぎないか？（改行不足）|可読性の低下
|処理名と内容が一致しているか？|予想外の箇所への影響
|似た処理の命名ルールが揃っているか？|可読性の低下

---

### 2. 「原則」に基づき "あるべき姿" を<br>　　導き出す

※言語・フレームワーク・PJ依存が大きいので、  
　今回ここは細かい解説を省略します

＜参考：プリンシプル例＞  
「KISS」「DRY」「YAGNI」etc...

---

### 3. **「技術的負債」の考え方を用いて<br>　　対応方針を検討する**

---

#### 原則（時間があるなら）

### "あるべき姿" に修正する

---

#### 原則（時間があるなら）

### "あるべき姿" に修正する

ただし、

- 手戻りが大きく、実装工数不足 |
- 影響範囲が広すぎて対応できない |
- 障害対応で急ぎのリリースが必要<br>などの理由で修正しきれないことは多々ある |

---

結果...

## 「技術的負債」

を抱えることになる！

---

## 技術的負債とは何か？

- 障害そのもの ではない |
- 「修正しにくい・理解しにくい」コード |
- 障害の温床になる <font color="red">**重大リスク**</font> です |

---

### 問題コードは「借金」である

1. 理解しにくい
1. 機能追加に時間がかかる
1. 障害発生しやすい・原因特定にも時間がかかる
1. 障害修正にも時間がかかる

放置すればするだけ影響が拡がり <font color="red">**悪循環**</font> を生む

---

- エンハンス工数増
- エンハンスによる障害発生リスク
- 障害対応の遅延
- （上記対応によって他エンハンスの遅延）

「修正しにくい・理解しにくい」コードを許容する  
というのはこれらのリスクを許容するのと同じこと

---

### 問題コードとうまく付き合う方法

---

#### 問題コードとうまく付き合う方法

リリースして難を凌いだら  
<font color="yellow">"すぐに"</font> きれいなコードに修正する

@ul[squares]

- 仕様・コードを覚えているうちにやる
- 担当者がいるうちにやる

@ulend

---

（ちょっと話がずれますが）

### そもそも発生しないように防ぐ

のが一番良い

※ソースレビューの段階で防ぐ、では  
　手遅れのケースも多い

---

#### よくある誘因

- スキル・経験不足のメンバー
- 締め切りのプレッシャー
- 読みにくい既存コード
- 単に悪い設計

---

これらはどうしても起きてしまうもの  
→ ただし <font color="yellow">**解消はできる**</font>  
　できていないのであれば  

## <font color="red">チーム文化に問題がある</font>

---

#### チームの文化（悪い例）

- メンバーの成長を計画的に行えていない
- リファクタリングに時間を割かない
- 膨大な依存性を抱えたコードの修正を躊躇する
- きれいなコードを書こうとしない
- 不明瞭なコードがあっても受け入れてしまう

---

＜アーキテクトとしての考え方＞

「技術特化だからチーム改善はしない」

---

＜アーキテクトとしての考え方＞

~~「技術特化だからチーム改善はしない」~~

<font color="yellow">**「技術特化だからコードをキレイに保つために<br>　チーム改善をする」**</font>

---

## まとめ

---

原則に基づいて最適なコードを書くことが、  
「息の長いコードを残す」ためには必要。

@ul[squares]

- とはいえ実際常に完璧なコードを書くことは不可能<br>※スキル不足、考慮漏れ、古くからの負債
- 負債との付き合い方（管理・解消する仕組み作り）が<br>**とても大事**

@ulend

---

最後に

---

### 最終的に言いたかったこと

# しっかりした価値観を持て

（「SEを極める50の鉄則」より）

---

> 第一線のSEはしっかりとした考え方・価値観を持たなければならない

@ul[squares]

- 若い時の経験がカギ
- 普遍的な価値観を身に付けよ

@ulend

---

> 第一線のSEはしっかりとした考え方・価値観を持たなければならない

- 若い時の経験がカギ
- <font color="red">普遍的な価値観を身に付けよ</font>
  - プリンシプル |

---

言語やフレームワークについての学習はもちろん必要  
（若手の時はどうしてもそこに目が行きがち）

---

しかし、  
どんな環境でも使える「普遍的な価値観」の方が、  
<font color="yellow">「ブレない指摘」ができレビューの質が安定する</font>

1ステップ上を目指している若手層は、  
今一度基本に立ち返るのが良いかもしれません

---

### <div style="text-align: center;">ご静聴ありがとうございました</font>

---

#### 参考書籍

- [プリンシプル オブ プログラミング 3年目までに身につけたい 一生役立つ101の原理原則](https://www.amazon.co.jp/dp/B071V7MY82)
- [新装版 リファクタリング―既存のコードを安全に改善する―](https://www.amazon.co.jp/dp/427405019X)
- [プログラマが知るべき97のこと](https://www.amazon.co.jp/dp/4873114799)
- [SEを極める50の鉄則](https://www.amazon.co.jp/dp/4822207773)
